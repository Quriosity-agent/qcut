# æ•°æ®åº“è¿‡åº¦åˆ›å»º Bug å‘ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-24
**å‘ç°è€…**: E2E æµ‹è¯•è°ƒæŸ¥
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - æ€§èƒ½å½±å“

---

## ğŸ” é—®é¢˜æ‘˜è¦

åœ¨ E2E æµ‹è¯•æœŸé—´ï¼Œåº”ç”¨åœ¨å•æ¬¡æµ‹è¯•è¿è¡Œä¸­åˆ›å»ºäº† **300+ ä¸ª IndexedDB æ•°æ®åº“**ï¼Œå°½ç®¡æµ‹è¯•åªåˆ›å»ºäº† **1 ä¸ªé¡¹ç›®**ã€‚

## ğŸ“Š è¯æ®

### æµ‹è¯•ç»“æœ
æ¯ä¸ª sticker æµ‹è¯•æ¸…ç†æ—¶åˆ é™¤çš„æ•°æ®åº“æ•°é‡ï¼š
- Test 1: **327 ä¸ªæ•°æ®åº“**
- Test 2: **329 ä¸ªæ•°æ®åº“**
- Test 3: **331 ä¸ªæ•°æ®åº“**
- Test 4: **297 ä¸ªæ•°æ®åº“**
- Test 5: **311 ä¸ªæ•°æ®åº“**
- Test 6: **337 ä¸ªæ•°æ®åº“**

### æ•°æ®åº“åç§°ç¤ºä¾‹
```
1. frame-cache
2. video-editor-media-004a96f5-1385-4fe8-af8b-40ae4e25d2fd
3. video-editor-media-025db3d0-0a92-40f5-9d01-3bb2cda99466
4. video-editor-media-05bdd69d-abc7-4059-b0e2-50c31da0b746
5. video-editor-media-06ac5bee-d8cf-47ea-8f41-02136d405a07
... å’Œ 320+ ä¸ªæ›´å¤š
```

**æ¨¡å¼**: `video-editor-media-{UUID}`

## ğŸ› æ ¹æœ¬åŸå› 

### é¢„æœŸè¡Œä¸º
æ¯ä¸ªé¡¹ç›®åº”è¯¥åˆ›å»º **3 ä¸ªæ•°æ®åº“**ï¼š
1. `qcut-projects` - é¡¹ç›®åˆ—è¡¨
2. `video-editor-media-{projectId}` - åª’ä½“æ•°æ®
3. `video-editor-timeline-{projectId}` - æ—¶é—´çº¿æ•°æ®

### å®é™…è¡Œä¸º
åº”ç”¨åœ¨**æ¯æ¬¡æŸç§æ“ä½œæ—¶**éƒ½ç”Ÿæˆ**æ–°çš„é¡¹ç›® ID (UUID)**ï¼Œå¯¼è‡´åˆ›å»ºæ•°ç™¾ä¸ªç‹¬ç«‹çš„æ•°æ®åº“ã€‚

### ä»£ç ä½ç½®
```typescript
// apps/web/src/lib/storage/storage-service.ts:85-88
const mediaMetadataAdapter = new IndexedDBAdapter<MediaFileData>(
  `${this.config.mediaDb}-${projectId}`,  // æ¯æ¬¡è°ƒç”¨éƒ½ç”¨ä¸åŒçš„ projectId
  "media-metadata",
  this.config.version
);
```

## ğŸ”¬ å¯èƒ½çš„åŸå› 

1. **çŠ¶æ€é‡ç½®**: æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æˆ–çŠ¶æ€æ›´æ–°æ—¶ç”Ÿæˆæ–°çš„é¡¹ç›® ID
2. **å¯¼èˆªé—®é¢˜**: é¡µé¢å¯¼èˆªæ—¶é‡æ–°ç”Ÿæˆé¡¹ç›® ID
3. **UUID ç”Ÿæˆ Bug**: é¡¹ç›® ID ç”Ÿæˆé€»è¾‘åœ¨ä¸åº”è¯¥è°ƒç”¨çš„åœ°æ–¹è¢«è°ƒç”¨
4. **æ—¶é—´è§¦å‘å™¨**: å®šæ—¶å™¨æˆ–é—´éš”è§¦å‘å™¨é‡å¤åˆ›å»ºé¡¹ç›®

## âœ… æµ‹è¯•åŸºç¡€è®¾æ–½éªŒè¯

**é‡è¦**: æµ‹è¯•æ¸…ç†åŠŸèƒ½ **æ­£å¸¸å·¥ä½œ**ï¼

| æ–¹é¢ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ•°æ®åº“æ¸…ç† | âœ… æ­£å¸¸ | æ‰€æœ‰ 300+ ä¸ªæ•°æ®åº“éƒ½è¢«æ­£ç¡®åˆ é™¤ |
| æµ‹è¯•éš”ç¦» | âœ… æ­£å¸¸ | æ¯ä¸ªæµ‹è¯•å¼€å§‹æ—¶æ•°æ®åº“æ˜¯å¹²å‡€çš„ (0 ä¸ªæ•°æ®åº“) |
| æµ‹è¯•ç»“æœ | âœ… é€šè¿‡ | 6/6 sticker æµ‹è¯•å…¨éƒ¨é€šè¿‡ (100%) |
| æµ‹è¯•åçŠ¶æ€ | âœ… å¹²å‡€ | 0 ä¸ªé¡¹ç›®æ–‡ä»¶ï¼ŒIndexedDB ä¸å­˜åœ¨ |

**ç»“è®º**: è¿™æ˜¯**åº”ç”¨é€»è¾‘ bug**ï¼Œä¸æ˜¯æµ‹è¯•åŸºç¡€è®¾æ–½é—®é¢˜ã€‚

## ğŸ“ˆ æ€§èƒ½å½±å“

### å­˜å‚¨ç©ºé—´
- æ¯ä¸ªæµ‹è¯•: ~300 ä¸ªæ•°æ®åº“
- å¦‚æœä¸æ¸…ç†: åœ¨ç”¨æˆ·è®¾å¤‡ä¸Šä¼šæ— é™ç´¯ç§¯
- æ½œåœ¨çš„ç£ç›˜ç©ºé—´æµªè´¹

### æ€§èƒ½
- åˆ›å»º 300 ä¸ªæ•°æ®åº“ä¼šå‡æ…¢åº”ç”¨é€Ÿåº¦
- IndexedDB æ“ä½œå¼€é”€
- å¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒå»¶è¿Ÿ

### ç”¨æˆ·å½±å“
å¦‚æœæ­¤ bug åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å­˜åœ¨ï¼š
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°å¤šä¸ªé‡å¤çš„é¡¹ç›®
- æ•°æ®åº“æ–‡ä»¶ä¼šéšæ—¶é—´ç´¯ç§¯
- åº”ç”¨æ€§èƒ½ä¸‹é™

## ğŸ”§ æ¨èçš„è°ƒæŸ¥æ­¥éª¤

### 1. æŸ¥æ‰¾é¡¹ç›® ID ç”Ÿæˆä½ç½®
```bash
cd qcut
grep -r "uuid()" apps/web/src --include="*.ts" --include="*.tsx"
grep -r "generateId\|createId\|newId" apps/web/src
```

### 2. æ£€æŸ¥é¡¹ç›®åˆ›å»ºé€»è¾‘
- æŸ¥çœ‹ `apps/web/src/stores/` ä¸­çš„é¡¹ç›®çŠ¶æ€ç®¡ç†
- æ£€æŸ¥ `apps/web/src/routes/editor.$project_id.tsx` çš„å¯¼èˆªé€»è¾‘
- éªŒè¯é¡¹ç›®åˆ›å»ºæŒ‰é’®çš„ç‚¹å‡»å¤„ç†

### 3. æ·»åŠ æ—¥å¿—
åœ¨é¡¹ç›® ID ç”Ÿæˆå¤„æ·»åŠ  `console.trace()` æ¥æŸ¥çœ‹è°ƒç”¨å †æ ˆï¼š
```typescript
const projectId = generateId();
console.trace('Project ID generated:', projectId);
```

### 4. æ£€æŸ¥å‰¯ä½œç”¨
- React useEffect æ˜¯å¦åœ¨æ— é™å¾ªç¯ï¼Ÿ
- Zustand store è®¢é˜…æ˜¯å¦å¯¼è‡´é‡æ–°åˆ›å»ºï¼Ÿ
- è·¯ç”±å‚æ•°å˜åŒ–æ˜¯å¦è§¦å‘æ–°é¡¹ç›®åˆ›å»ºï¼Ÿ

## ğŸ“ å¤ç°æ­¥éª¤

### ä½¿ç”¨æµ‹è¯•
```bash
cd qcut
bun x playwright test --project=electron sticker-overlay-testing.e2e.ts
```

æµ‹è¯•ä¼šæ˜¾ç¤ºæ¸…ç†äº†å¤šå°‘ä¸ªæ•°æ®åº“ã€‚

### ä½¿ç”¨è¯Šæ–­è„šæœ¬
```bash
# æµ‹è¯•å‰è®¡æ•°
python docs/issues/e2e-test-errors/count-projects.py > before.txt

# æ‰‹åŠ¨è¿è¡Œåº”ç”¨å¹¶åˆ›å»ºä¸€ä¸ªé¡¹ç›®
bun run electron

# æµ‹è¯•åè®¡æ•°
python docs/issues/e2e-test-errors/count-projects.py > after.txt

# æ¯”è¾ƒ
diff before.txt after.txt
```

### åœ¨æµè§ˆå™¨æ§åˆ¶å°
1. æ‰“å¼€åº”ç”¨
2. æ‰“å¼€å¼€å‘è€…å·¥å…·æ§åˆ¶å°
3. ç²˜è´´å¹¶è¿è¡Œ `docs/issues/e2e-test-errors/inspect-databases.js` çš„å†…å®¹
4. æ‰§è¡Œä¸€äº›æ“ä½œï¼ˆåˆ›å»ºé¡¹ç›®ï¼Œæ·»åŠ åª’ä½“ç­‰ï¼‰
5. å†æ¬¡è¿è¡Œè„šæœ¬æŸ¥çœ‹æ•°æ®åº“å¢é•¿

## ğŸ¯ é¢„æœŸä¿®å¤

ä¿®å¤åï¼Œå•ä¸ªæµ‹è¯•åº”è¯¥åªåˆ›å»º **~3-5 ä¸ªæ•°æ®åº“**ï¼š
- 1 ä¸ªé¡¹ç›®æ•°æ®åº“
- 1 ä¸ªåª’ä½“æ•°æ®åº“
- 1 ä¸ªæ—¶é—´çº¿æ•°æ®åº“
- 1-2 ä¸ªç¼“å­˜/ä¸´æ—¶æ•°æ®åº“

**ä¸åº”è¯¥**æœ‰ 300+ ä¸ªå…·æœ‰å”¯ä¸€ UUID çš„æ•°æ®åº“ã€‚

## ğŸ“š ç›¸å…³æ–‡ä»¶

### è¯Šæ–­å·¥å…·
- `docs/issues/e2e-test-errors/count-projects.py` - è®¡ç®—é¡¹ç›®æ•°é‡
- `docs/issues/e2e-test-errors/inspect-databases.js` - æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
- `apps/web/src/test/e2e/helpers/electron-helpers.ts` - å¢å¼ºçš„æ¸…ç†æ—¥å¿—

### éœ€è¦æ£€æŸ¥çš„ä»£ç 
- `apps/web/src/lib/storage/storage-service.ts` - æ•°æ®åº“åˆ›å»ºé€»è¾‘
- `apps/web/src/stores/project-store.ts` - é¡¹ç›®çŠ¶æ€ç®¡ç†ï¼ˆå¯èƒ½ï¼‰
- `apps/web/src/routes/editor.$project_id.tsx` - ç¼–è¾‘å™¨è·¯ç”±
- ä»»ä½•è°ƒç”¨ `getProjectMediaAdapters()` æˆ– `getProjectTimelineAdapter()` çš„åœ°æ–¹

## ğŸ’¡ ä¸‹ä¸€æ­¥

1. â³ **è°ƒæŸ¥**: æ‰¾åˆ°é¡¹ç›® ID è¢«è¿‡åº¦ç”Ÿæˆçš„ç¡®åˆ‡ä½ç½®
2. â³ **ä¿®å¤**: ç¡®ä¿æ¯ä¸ªç”¨æˆ·æ“ä½œåªåˆ›å»ºä¸€ä¸ªé¡¹ç›®
3. â³ **éªŒè¯**: é‡æ–°è¿è¡Œ E2E æµ‹è¯•ç¡®è®¤åªåˆ›å»º 3-5 ä¸ªæ•°æ®åº“
4. â³ **å›å½’æµ‹è¯•**: ç¡®ä¿ä¿®å¤ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½

---

**çŠ¶æ€**: ğŸ” å·²è¯†åˆ«ï¼Œç­‰å¾…åº”ç”¨å›¢é˜Ÿè°ƒæŸ¥å’Œä¿®å¤
**ä¼˜å…ˆçº§**: é«˜ - å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
**è”ç³»äºº**: è¯·å‚è€ƒæ­¤æ–‡æ¡£è¿›è¡Œè°ƒæŸ¥
