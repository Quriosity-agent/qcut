# Error Report: ERR-1762491029039-BNRXS2

- **Timestamp**: _add when reproduced_
- **Environment**: QCut desktop (Electron) – `app://` bundle
- **Area**: AI Images › Model Type Toggle (Text2ImageView)

## Symptom
Switching into the updated AI Images view triggers a fatal React error:

```
Error ID: ERR-1762491029039-BNRXS2
Error: Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate. React limits the number of nested updates to prevent infinite loops.
    at UF (app://./assets/vendor-react-waUpj2M3.js:178:760)
    at wn (app://./assets/vendor-react-waUpj2M3.js:174:16163)
    at L3 (app://./assets/vendor-react-waUpj2M3.js:143:10956)
    at app://./assets/vendor-react-waUpj2M3.js:291:38165
    at N_ (app://./assets/vendor-react-waUpj2M3.js:242:5848)
    at app://./assets/vendor-react-waUpj2M3.js:242:5940
    at Array.map (<anonymous>)
    at app://./assets/vendor-react-waUpj2M3.js:242:5924
    at N_ (app://./assets/vendor-react-waUpj2M3.js:242:5848)
    at app://./assets/vendor-react-waUpj2M3.js:242:5940
```

## Notes / Leads
- Likely tied to a state update loop in the new `ModelTypeSelector`/`UpscaleSettings` interaction or the store auto-selection logic.
- Occurs immediately after the component renders, before user interaction (per reporter), indicating `useEffect` or render-time setters.
- Check `useText2ImageStore.setModelType` and the `setUpscaleSettings` logic for setState cascades.

## Impacted Files
- `qcut/apps/web/src/components/editor/media-panel/views/text2image.tsx`
- `qcut/apps/web/src/components/editor/media-panel/views/model-type-selector.tsx`
- `qcut/apps/web/src/components/editor/media-panel/views/upscale-settings.tsx`
- `qcut/apps/web/src/stores/text2image-store.ts`
- `qcut/apps/web/src/components/editor/media-panel/views/use-upscale-generation.ts`

## Investigation Subtasks
1. **Understand the error**
   - Reproduce the crash in the desktop build with React DevTools open to capture the cascading `setState` calls.
   - Confirm whether the loop begins when `modelType` transitions to `"upscale"` or if it is triggered earlier by store listeners.
2. **Read the relevant code**
   - Trace state transitions across the impacted files above, focusing on effects that set store values during render.
   - Document any circular dependency between `setModelType`, `setUpscaleSettings`, and the `useUpscaleGeneration` hook.
3. **Propose a fix**
   - Outline guard conditions (e.g., short-circuiting setters when the requested value already matches state) and where they should live.
   - Break the proposal into code-level subtasks (store guard, selector cleanup, hook effect refactor) so implementation can proceed stepwise.

## Subtask Updates
### 1. Understand the error
- ⚠️ Unable to run the packaged Electron app inside the current read-only sandbox, so reproduction relied on the captured stack trace and existing console logs. The crash happens immediately after navigating to the AI Images tab—before any button clicks—so the offending state updates are part of the initial render path.
- The stack frame that references `Array.map (<anonymous>)` lines up with `TEXT2IMAGE_MODEL_ORDER.map(...)` in `qcut/apps/web/src/components/editor/media-panel/views/text2image.tsx:242-285`, which is rendered as soon as `modelType === "generation"`. This matches the observation that the panel now defaults to the open “Select Models” popover and iterates all eight models on mount.
- Because the store defaults (`modelType: "generation"`, `selectedModels: [...TEXT2IMAGE_MODEL_ORDER]`) already flip multiple booleans, any render-time setter inside that map would immediately loop and trigger React’s depth limit, explaining why the crash fires without user interaction.

### 2. Read relevant code
- `text2image-store.ts:151-211` exposes `setModelType` and the heavy `setUpscaleSettings` reducer. Both setters currently call `set` unconditionally, even when the incoming values haven’t changed, so any accidental redundant invocation will still enqueue another render cycle.
- In `text2image.tsx:242-289` the single-select mode handler loops through every entry in `selectedModels` and calls `toggleModel` for each one before toggling the newly requested model. Each `toggleModel` call triggers its own `set`, so a single user action (or a duplicated event) can cascade 7–8 synchronous updates.
- `FloatingActionPanelModelOption` (`qcut/apps/web/src/components/ui/floating-action-panel.tsx:214-267`) wires the same `onCheckedChange` handler to both the wrapping `div` (`onClick`) and the nested checkbox component. A single click on the checkbox therefore fires the handler twice (capture + bubble), which in turn calls `toggleModel` twice. When combined with the single-mode loop above, the selection thrashes between “all off” and “reselect first entry,” a plausible source of the infinite loop that React reports.
- Upscale-specific pieces (`model-type-selector.tsx`, `upscale-settings.tsx`, and `use-upscale-generation.ts`) do not update state during render, but they rely on the same store instance as the generation UI. Any cascading loop in the selector therefore prevents the upscale tab from ever mounting.

### 3. Proposed fix & subtasks
1. **Guard store setters (`qcut/apps/web/src/stores/text2image-store.ts`)**
   - Short-circuit `setModelType` when `type === get().modelType`.
   - Expand `setUpscaleSettings` to compare the computed payload with `state.upscaleSettings`; skip `set` if nothing changed to prevent “same value” thrash.
2. **Deduplicate model-selection updates**
   - Introduce a `selectModels(nextModels: string[])` action so the single-mode logic can replace the `forEach(toggleModel)` loop with one atomic update.
   - Update `FloatingActionPanelModelOption` to fire `onCheckedChange` once per interaction (either remove the parent `onClick` or call `event.stopPropagation()` when the checkbox handles the event).
   - Add guards so `toggleModel` and `setGenerationMode` won’t enqueue additional updates when the incoming array already matches the requested state.
3. **Verification & regression**
   - Add a component test (React Testing Library) that mounts `Text2ImageView`, switches `modelType` to `"upscale"`, and asserts no “Maximum update depth” error is logged.
   - Extend the existing e2e flow in `qcut/apps/web/tests/e2e/ai-enhancement-export-integration.e2e.ts` to visit AI Images, toggle between Generation ⇄ Upscale, and ensure the renderer process console stays clean.

## Implementation Details & Targeted Code Changes
### `qcut/apps/web/src/stores/text2image-store.ts`
- **Guard repeated setters**
  ```ts
  setModelType: (type) => {
    if (type === get().modelType) return;
    set({ modelType: type });
  };
  ```
  Prevents a redundant setter (e.g., when the selector double-fires) from re-rendering the entire view.
- **Idempotent upscale settings**
  ```ts
  setUpscaleSettings: (settings) =>
    set((state) => {
      const next = buildUpscaleSettings(state.upscaleSettings, settings);
      if (shallowEqual(next, state.upscaleSettings)) return state;
      return { upscaleSettings: next };
    });
  ```
  `buildUpscaleSettings` reuses the existing logic; `shallowEqual` compares primitives/booleans to avoid unnecessary store writes.
- **New atomic `selectModels` action**
  ```ts
  selectModels: (models) =>
    set((state) =>
      arraysEqual(state.selectedModels, models)
        ? state
        : { selectedModels: models }
    );
  ```
  Lets the UI replace the whole selection in one update during single-mode toggles instead of spamming `toggleModel`.
- **Safer `toggleModel`**
  Wrap the `selectedModels.includes` checks so that clicking a checkbox already in the desired state is a no-op.

### `qcut/apps/web/src/components/editor/media-panel/views/text2image.tsx`
- Import the new `selectModels` action:
  ```ts
  const { ..., toggleModel, selectModels, ... } = useText2ImageStore();
  ```
- Replace the single-mode `forEach(toggleModel)` block with:
  ```ts
  if (generationMode === "single") {
    if (checked) {
      selectModels([modelId]);
    } else {
      selectModels([]);
    }
    return;
  }
  toggleModel(modelId);
  ```
  This yields a single store update regardless of how many models were previously selected.
- When switching generation modes (`setGenerationMode` handler), rely on `selectModels` to set curated defaults without multiple `set` calls.

### `qcut/apps/web/src/components/ui/floating-action-panel.tsx`
- Remove the wrapper `div`’s `onClick` and let the checkbox drive selection:
  ```tsx
  <div className="..." /* no onClick here */>
    <FloatingActionPanelCheckbox
      id={id}
      checked={checked}
      onCheckedChange={(next) => {
        if (next === checked) return;
        onCheckedChange?.(next);
      }}
    />
    ...
  </div>
  ```
  Alternatively, keep the wrapper clickable but call `event.stopPropagation()` so `onCheckedChange` fires exactly once per interaction.

### Tests & Regression Coverage
- **Component test** (`qcut/apps/web/src/components/editor/media-panel/views/__tests__/text2image.test.tsx`):
  - Mount `Text2ImageView`, toggle single→multi→upscale, assert no `console.error` with “Maximum update depth exceeded”, and confirm `selectModels` receives expected payloads (spy on store).
- **E2E** (`qcut/apps/web/tests/e2e/ai-enhancement-export-integration.e2e.ts`):
  - Script: open AI Images, click each Model Type tab once, ensure screenshot/test runner doesn’t capture repeated toggles and the run completes.

## Console Verification
- After implementing the changes, enable the existing `DEBUG_TEXT2IMAGE` flag (set to `true`) and reload the AI Images panel.
- Expected console output when selecting a model in single mode:
  ```
  ✅ TEXT2IMAGE: selectModels(["nano-banana"]) (no redundant toggles)
  ```
  and **no** recurrence of `Error: Maximum update depth exceeded`. The absence of the React error plus the single debug line confirms the selector now updates state exactly once per interaction.
- Current environment cannot run the packaged Electron app, so capture the message above on the next desktop build run to close this issue.

## Implementation Log (2025-11-07)
- ✅ `qcut/apps/web/src/stores/text2image-store.ts`
  - Added `selectModels` and `setModelSelection` actions plus guards for `setModelType`/`setUpscaleSettings` to short-circuit redundant updates.
  - `setGenerationMode` now compares the requested mode before mutating and seeds curated defaults via `selectModels`.
  - `toggleModel` delegates to `setModelSelection`, ensuring one store write per user intent.
- ✅ `qcut/apps/web/src/components/editor/media-panel/views/text2image.tsx`
  - The model picker now uses the new store actions, so single-mode replaces the selection atomically and multi-mode respects the `checked` flag rather than blindly toggling.
- ✅ `qcut/apps/web/src/components/ui/floating-action-panel.tsx`
  - Checkbox clicks call `stopPropagation()` so the wrapper row fires exactly once, preventing double toggles that caused the infinite loop.
- ⚠️ Tests pending: `pnpm` is unavailable in this sandbox, so rerun unit + e2e suites locally to confirm no regressions once tooling is accessible.

_Attach additional context or logs to this file as findings arrive._
