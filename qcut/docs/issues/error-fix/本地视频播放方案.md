# 本地视频播放方案（Blob 优先）

## 目标
- **长期支持**：与现有架构兼容，后续可扩展 CSP/远程回退、用户偏好等。
- **最小改动**：在播放器侧集中处理，不扰动现有生成/存储流程。
- **不破坏现有功能**：无本地文件时自动回退远程 URL，保持现有播放路径。

---

## 实施步骤

1. **封装播放源选择函数**（新增）
   - 位置：`qcut/apps/web/src/lib/media-source.ts`（或播放器同文件顶部）。
   - 逻辑：
     - 有 `mediaItem.file` → `URL.createObjectURL(file)` 作为首选。
     - 无本地文件再检查 `mediaItem.url`，域名在 CSP 白名单时用远程。
     - 否则返回 `null` 以提示不可播放。

   ```ts
   const CSP_ALLOWED = new Set(["fal.media", "v3.fal.media", "v3b.fal.media"]);

   export function getVideoSource(mediaItem: { file?: File; url?: string }) {
     if (mediaItem.file) return { src: URL.createObjectURL(mediaItem.file), type: "blob" };
     if (mediaItem.url) {
       try {
         if (CSP_ALLOWED.has(new URL(mediaItem.url).hostname)) {
           return { src: mediaItem.url, type: "remote" };
         }
       } catch {}
     }
     return null;
   }
   ```

2. **播放器接入 blob 并管理清理**（改动点极少）
   - 适用文件：`timeline-track.tsx`、`video-player.tsx`、`preview-panel.tsx` 等直接为 `<video>` 设置 `src` 的组件。
   - 做法：
     - 调用 `getVideoSource(mediaItem)` 获取 `{ src, type }`。
     - 用 `useRef` 记录当前 blob URL，组件卸载或 `mediaItem` 变化时 `URL.revokeObjectURL`，防内存泄漏。
     - 若返回 `null`，提示“无可用视频源”。

   ```tsx
   const objectUrlRef = useRef<string | null>(null);
   const source = useMemo(() => {
     if (objectUrlRef.current?.startsWith("blob:")) {
       URL.revokeObjectURL(objectUrlRef.current);
       objectUrlRef.current = null;
     }
     const next = getVideoSource(mediaItem);
     if (next?.type === "blob") objectUrlRef.current = next.src;
     return next;
   }, [mediaItem]);

   useEffect(() => () => {
     if (objectUrlRef.current?.startsWith("blob:")) {
       URL.revokeObjectURL(objectUrlRef.current);
     }
   }, []);
   ```

3. **保持远程回退以不破坏现有功能**
   - 当 `mediaItem.file` 缺失时，自动落到远程 URL，现有播放路径不变。
   - 若远程域名不在白名单，可在 UI 提示或扩展 `CSP_ALLOWED`，不影响离线播放。

4. **可选扩展（长期支持）**
   - 用户偏好：本地/远程/自动三档设置，存储在设置或 store。
   - 诊断日志：输出当前选源（blob/remote），便于排查。
   - 统一清理：抽出 `useBlobCleanup` Hook 复用。

---

## 验证清单
- 有本地 file → `video.src` 为 `blob:`，离线可播。
- 无本地 file → 回退远程 URL，仍可播放。
- 切换视频/卸载组件 → blob URL 被 `revokeObjectURL`，无泄漏。
- CSP 阻断远程时，本地仍可播；白名单扩展后远程可用。
- 时间轴/预览/主播放器均使用同一选源逻辑，行为一致。

---

## 变更范围评估
- 新增：`media-source.ts`（纯函数）。
- 修改：播放器内 `src` 赋值及 blob 清理逻辑；不触碰生成、下载、存储流程。
- 兼容性：无 file 时行为等同旧版；有 file 时优先用本地以规避 CSP、提升性能。
