# Fal.ai Generated Video Local File Save Implementation

## Problem Statement
Currently, fal.ai generated videos are stored as blob URLs (`blob:app://...`) or remote URLs (`https://v3b.fal.media/...`) in memory. These need to be saved as actual files on the local disk for persistence and proper media panel integration.

## Current Flow Analysis
Based on the console logs in `consolev6.md`:
1. Video is successfully generated by fal.ai (Step 5)
2. Video is downloaded as a blob and File object is created (Step 6)
3. Blob URL is created: `blob:app://./1829cd32-ce9a-4e03-81db-e69c07d9e4af`
4. File is added to media store with both `url` (blob) and `originalUrl` (remote)
5. **Missing**: Actual file save to disk

## Proposed Solution

### 1. Add Electron IPC Handler for File Save
Create a new IPC handler in the Electron main process to save video files to disk:

```typescript
// electron/video-save-handler.ts
interface SaveVideoOptions {
  fileName: string;
  fileData: ArrayBuffer | Buffer;
  projectId: string;
}

ipcMain.handle('video:save-to-disk', async (event, options: SaveVideoOptions) => {
  const { fileName, fileData, projectId } = options;

  // Create project-specific directory
  const videosPath = path.join(app.getPath('userData'), 'projects', projectId, 'videos');
  await fs.promises.mkdir(videosPath, { recursive: true });

  // Save file
  const filePath = path.join(videosPath, fileName);
  await fs.promises.writeFile(filePath, Buffer.from(fileData));

  return filePath;
});
```

### 2. Update Media Store Integration (Step 6)
Modify `use-ai-generation.ts` to save the file to disk before adding to media store:

```typescript
// Step 6d enhancement: Save to disk
if (window.electronAPI?.video) {
  const arrayBuffer = await blob.arrayBuffer();
  const localFilePath = await window.electronAPI.video.saveToDisk({
    fileName: fileName,
    fileData: arrayBuffer,
    projectId: activeProject
  });

  // Update mediaItem with local file path
  mediaItem.localPath = localFilePath;
  mediaItem.isLocalFile = true;
}
```

### 3. Media Panel File Reference Strategy

#### File Storage Structure
```
userData/
└── projects/
    └── [projectId]/
        └── videos/
            ├── AI-Video-ltxv2_fast_t2v-1763529508058.mp4
            └── AI-Video-minimax_video-1763529608123.mp4
```

#### Media Item Data Model
```typescript
interface MediaItem {
  id: string;
  name: string;
  type: 'video' | 'audio' | 'image';

  // File references (priority order)
  localPath?: string;      // 1st priority: Local disk file path
  url: string;             // 2nd priority: Blob URL (session only)
  originalUrl?: string;    // 3rd priority: Remote fal.ai URL (fallback)

  // Metadata
  isLocalFile: boolean;    // True if saved to disk
  fileSize: number;
  duration?: number;
  width?: number;
  height?: number;
  createdAt: number;
}
```

### 4. File Access Priority System

#### Playback Priority (in Media Panel)
1. **Local File**: Use `file://` protocol with `localPath`
2. **Blob URL**: Use in-memory blob (session only)
3. **Remote URL**: Fetch from fal.ai server (requires internet)

#### Export/Download Priority
1. **Local File**: Direct file copy from disk
2. **Remote URL**: Fetch and save (with progress indicator)

### 5. Implementation Steps

#### Step 6 Modifications (use-ai-generation.ts)
```typescript
// After Step 6d: file creation complete
console.log("step 6d: file creation complete", {
  blob.size,
  blob.type,
  file.name,
  file.size
});

// NEW: Step 6e: Save to local disk
if (window.electronAPI?.video?.saveToDisk) {
  try {
    console.log("step 6e: saving video to local disk");
    const arrayBuffer = await blob.arrayBuffer();
    const localPath = await window.electronAPI.video.saveToDisk({
      fileName: fileName,
      fileData: arrayBuffer,
      projectId: activeProject
    });

    console.log("step 6e: video saved to disk", { localPath, size: arrayBuffer.byteLength });

    // Update media item with local path
    mediaItem.localPath = localPath;
    mediaItem.isLocalFile = true;
  } catch (error) {
    console.error("step 6e: failed to save video to disk", error);
    // Continue with blob URL fallback
  }
}
```

#### Media Store Updates (media-store.ts)
```typescript
// In addMediaItem function
if (item.localPath) {
  // Verify file exists on disk
  const fileExists = await window.electronAPI?.file?.exists(item.localPath);
  if (!fileExists) {
    console.warn("Local file not found, falling back to URL", item.localPath);
    item.isLocalFile = false;
  }
}
```

### 6. Benefits of Local File Storage

1. **Persistence**: Videos remain available after app restart
2. **Performance**: No need to re-download from fal.ai
3. **Offline Access**: Works without internet connection
4. **Export Speed**: Faster ZIP creation for "Download All"
5. **Disk Management**: Organized project-based file structure

### 7. Migration for Existing Projects

For projects with existing blob/remote-only videos:
1. Detect videos without `localPath` on project load
2. Offer one-click "Save All to Disk" option
3. Download from `originalUrl` if blob expired
4. Update media items with new `localPath` values

### 8. Error Handling

```typescript
// Comprehensive error handling
try {
  const localPath = await saveVideoToDisk(blob, fileName, projectId);
  return { success: true, localPath };
} catch (error) {
  console.error("step 6e: disk save failed", error);

  // Fallback strategy
  if (error.code === 'ENOSPC') {
    // No space on disk
    showToast("Insufficient disk space. Video saved in memory only.");
  } else if (error.code === 'EACCES') {
    // Permission denied
    showToast("Permission denied. Check folder permissions.");
  }

  // Continue with blob URL only
  return { success: false, fallback: 'blob' };
}
```

### 9. Testing Checklist

- [ ] Video saves to correct project directory
- [ ] Local file path persists in media store
- [ ] Playback works from local file
- [ ] Export uses local file (not re-download)
- [ ] Fallback to blob/remote URL works
- [ ] Error handling for disk full scenario
- [ ] Migration of existing blob-only videos
- [ ] Cross-platform path handling (Windows/Mac/Linux)

### 10. Console Log Points for Debugging

```
step 6e: saving video to local disk
step 6e: video saved to disk { localPath: "...", size: 2880866 }
step 6e: disk save failed { error: "..." }
step 6f: addMediaItem completed { ..., localPath: "...", isLocalFile: true }
step 8: media panel download { source: "local", localPath: "..." }
```

## Implementation Priority

1. **Phase 1**: IPC handler for file save (electron/video-save-handler.ts)
2. **Phase 2**: Integration in use-ai-generation.ts (Step 6e)
3. **Phase 3**: Media panel updates for local file playback
4. **Phase 4**: Export optimization using local files
5. **Phase 5**: Migration tool for existing projects

## Notes

- File naming convention: `AI-Video-{modelId}-{timestamp}.mp4`
- Storage location: User's app data directory (platform-specific)
- Cleanup: Implement project deletion to remove associated video files
- Backup: Consider cloud sync for premium users