# 本地播放调试手册（为何仍用远程 URL）

目标：定位并确认为何播放器仍走远程链接，而未使用本地 File->blob。按步骤收集日志，即可看出问题所在。

## 日志观察顺序
1. **播放端选源日志**
   - 查看浏览器 Console 中：
     - `[PreviewPanel] Blur layer video source:` / `[PreviewPanel] Foreground video source:` → 值为 `blob` / `remote` / `none`。
     - `[media-source] Using blob source` / `Using remote source` / `No playable source available`。
   - 作用：最快确认当前到底走哪条源路径。

2. **渲染前 mediaItem 快照**
   - 文件：`qcut/apps/web/src/components/editor/preview-panel.tsx`
   - 在调用 `getVideoSource(mediaItem)` 前，确认：
     ```ts
     console.log("[PreviewPanel] mediaItem snapshot", {
       id: mediaItem.id,
       hasFile: !!mediaItem.file,
       fileName: mediaItem.file?.name,
       fileSize: mediaItem.file?.size,
       hasUrl: !!mediaItem.url,
     });
     ```
   - 作用：如果 hasFile 为 false，说明链路上 file 已丢失。

3. **生成阶段文件创建/传递**
   - 文件：`qcut/apps/web/src/components/editor/media-panel/views/use-ai-generation.ts`（下载/构建 File 并调用 addMediaItem 的位置）
   - 在创建 File 后、调用 addMediaItem 前加：
     ```ts
     console.log("[AIGen] Created file for mediaItem", {
       name: file.name,
       size: file.size,
       hasFile: !!file,
       url: newVideo.videoUrl,
     });
     console.log("[AIGen] addMediaItem payload", {
       hasFile: !!mediaItem.file,
       fileName: mediaItem.file?.name,
       hasUrl: !!mediaItem.url,
     });
     ```
   - 作用：确认生成端是否真的生成了 File 并传给 addMediaItem。

4. **存储层入参确认**
   - 文件：`qcut/apps/web/src/stores/media-store.ts` → `addMediaItem`
   - 加日志：
     ```ts
     console.log("[MediaStore.addMediaItem] incoming file", {
       hasFile: !!item.file,
       fileName: item.file?.name,
       fileSize: item.file?.size,
       url: item.url,
     });
     ```
   - 作用：如果这里 hasFile 为 false，生成端到 store 之间已丢失；否则存储成功后再看加载阶段。

5. **存储/加载检查（可选，如怀疑持久化丢失）**
   - 如果怀疑存储后取回缺 file，可在 `storageService.saveMediaItem` 和载入逻辑（`use-async-media-store.ts`）增加日志，确认从存储加载的对象是否仍有 file。

6. **CSP 白名单判定**
   - 文件：`qcut/apps/web/src/lib/media-source.ts`
   - 已存在日志：当 URL 不在白名单时会输出 `[media-source] Remote URL blocked by CSP whitelist`。如果 file 存在仍走远程，检查 CSP 白名单或逻辑异常。

## 快速判断逻辑
- 看到 `[media-source] Using blob source …` → 已走本地，问题解决。
- 看到 `[media-source] Using remote source …` 且 `hasFile:false` → File 在生成/存储链路缺失，按步骤 3/4 回溯。
- 看到 `[media-source] Remote URL blocked by CSP whitelist` → 白名单未包含域名，需扩展或确保本地 file 存在。
- 看到 `[media-source] No playable source available` → file 与 url 都缺失，检查生成/存储。

## 建议的最小操作
1. 按步骤 3/4 在生成端和 store 端各加一条日志，确认 hasFile 是否为 true。
2. 在预览端加 snapshot 日志（步骤 2）看最终 mediaItem 是否带 file。
3. 查看 Console 中 `[media-source]` 结果，判断是否已切到 blob。

只需这些日志即可定位是“文件没生成/没传入/没存储”还是“有文件但被 CSP/逻辑挡住”。
